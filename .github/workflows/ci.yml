name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  LIBCRUN_VERSION: "1.19.1"
  LIBKRUN_VERSION: "1.10.1"

jobs:
  # Linux: Full build and test with libcrun + libkrun
  linux:
    name: Linux (with libcrun + libkrun)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkgconf \
            autoconf \
            automake \
            libtool \
            make \
            gcc \
            git \
            python3 \
            jq \
            libseccomp-dev \
            libcap-dev \
            libyajl-dev \
            llvm-18 \
            libclang-18-dev \
            clang-18 \
            libvirglrenderer-dev \
            libepoxy-dev \
            libdrm-dev \
            libpipewire-0.3-dev
          
          # Debug: Show what libclang files exist  
          echo "=== Searching for libclang libraries ==="
          echo "--- LLVM-18 lib directory ---"
          ls -la /usr/lib/llvm-18/lib/libclang* 2>/dev/null || echo "  No files in /usr/lib/llvm-18/lib/"
          echo "--- x86_64-linux-gnu directory ---"
          ls -la /usr/lib/x86_64-linux-gnu/libclang* 2>/dev/null || echo "  No files in /usr/lib/x86_64-linux-gnu/"
          echo "--- Find all libclang .so files ---"
          find /usr -name "libclang*.so*" 2>/dev/null | head -20
          
          # Find the actual libclang shared library (resolve symlinks to find real file)
          echo ""
          echo "=== Finding libclang shared library ==="
          
          # First, check if libclang-18-dev provides a development symlink
          LIBCLANG_SO=""
          
          # Check LLVM-18's lib directory first
          if [ -e "/usr/lib/llvm-18/lib/libclang.so" ]; then
            LIBCLANG_SO="/usr/lib/llvm-18/lib/libclang.so"
          elif [ -e "/usr/lib/llvm-18/lib/libclang-18.so" ]; then
            LIBCLANG_SO="/usr/lib/llvm-18/lib/libclang-18.so"
          else
            # Find any libclang .so file
            LIBCLANG_SO=$(find /usr/lib -name "libclang*.so" -o -name "libclang*.so.*" 2>/dev/null | grep -v ".a$" | head -n 1)
          fi
          
          if [ -z "${LIBCLANG_SO}" ]; then
            echo "ERROR: Could not find any libclang shared library!"
            exit 1
          fi
          
          # Resolve to absolute path if symlink
          LIBCLANG_SO=$(readlink -f "${LIBCLANG_SO}")
          LIBCLANG_DIR=$(dirname "${LIBCLANG_SO}")
          
          echo "Found libclang: ${LIBCLANG_SO}"
          echo "Library directory: ${LIBCLANG_DIR}"
          
          # Create libclang.so symlink if it doesn't exist in that directory
          if [ ! -e "${LIBCLANG_DIR}/libclang.so" ]; then
            echo "Creating symlink: ${LIBCLANG_DIR}/libclang.so -> $(basename ${LIBCLANG_SO})"
            sudo ln -sf "$(basename ${LIBCLANG_SO})" "${LIBCLANG_DIR}/libclang.so"
          fi
          
          echo ""
          echo "=== Final libclang state ==="
          ls -la "${LIBCLANG_DIR}"/libclang*
          
          # Verify the library can be loaded
          echo ""
          echo "=== Testing libclang loading ==="
          python3 -c "import ctypes; lib = ctypes.CDLL('${LIBCLANG_DIR}/libclang.so'); print('SUCCESS: Loaded ${LIBCLANG_DIR}/libclang.so')"
          
          # Export environment variables for subsequent steps
          # IMPORTANT: LIBCLANG_PATH must be the DIRECTORY, not the full file path
          # clang-sys runtime feature searches for libclang.so within this directory
          echo "LIBCLANG_PATH=${LIBCLANG_DIR}" >> $GITHUB_ENV
          echo "LLVM_CONFIG_PATH=/usr/bin/llvm-config-18" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=${LIBCLANG_DIR}:/usr/local/lib:/usr/local/lib64" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:/usr/local/lib64/pkgconfig" >> $GITHUB_ENV
          
          # Update library cache
          sudo ldconfig
            

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy

      - name: Cache libcrun build
        id: cache-libcrun
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib/libcrun*
            /usr/local/lib/pkgconfig/libcrun.pc
            /usr/local/include/libcrun
            /usr/local/include/ocispec
            /usr/local/include/config.h
            /usr/local/bin/crun
          key: libcrun-ubuntu-${{ env.LIBCRUN_VERSION }}-v6

      - name: Build libcrun
        if: steps.cache-libcrun.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch ${{ env.LIBCRUN_VERSION }} \
            https://github.com/containers/crun.git /tmp/crun
          cd /tmp/crun
          
          ./autogen.sh
          ./configure \
            --prefix=/usr/local \
            --disable-systemd
          
          make -j$(nproc)
          sudo make install
          
          # Manually create pkgconfig file (crun doesn't provide one)
          sudo mkdir -p /usr/local/lib/pkgconfig
          sudo tee /usr/local/lib/pkgconfig/libcrun.pc << 'PKGEOF'
          prefix=/usr/local
          exec_prefix=${prefix}
          libdir=${exec_prefix}/lib
          includedir=${prefix}/include
          
          Name: libcrun
          Description: OCI runtime library
          Version: ${{ env.LIBCRUN_VERSION }}
          Libs: -L${libdir} -lcrun -lyajl -lseccomp -lcap
          Cflags: -I${includedir}
          PKGEOF
          
          # Install headers
          sudo mkdir -p /usr/local/include/libcrun
          sudo mkdir -p /usr/local/include/ocispec
          sudo cp src/libcrun/*.h /usr/local/include/libcrun/
          sudo cp config.h /usr/local/include/
          # Copy ocispec headers (generated during build)
          find libocispec -name "*.h" -exec sudo cp {} /usr/local/include/ocispec/ \;

      - name: Install libkrunfw from prebuilt release
        run: |
          # Download the latest prebuilt libkrunfw (required by libkrun)
          LIBKRUNFW_TAG=$(curl -sL https://api.github.com/repos/containers/libkrunfw/releases/latest | jq -r .tag_name)
          echo "Installing libkrunfw ${LIBKRUNFW_TAG}"
          curl -L -o /tmp/libkrunfw-x86_64.tgz \
            "https://github.com/containers/libkrunfw/releases/download/${LIBKRUNFW_TAG}/libkrunfw-x86_64.tgz"
          mkdir -p /tmp/libkrunfw-extract
          tar xf /tmp/libkrunfw-x86_64.tgz -C /tmp/libkrunfw-extract
          # Install to system library path (same as libkrun's CI does)
          sudo mv /tmp/libkrunfw-extract/lib64/* /lib/x86_64-linux-gnu/
          sudo ldconfig

      - name: Cache libkrun build
        id: cache-libkrun
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib64/libkrun*
            /usr/local/lib64/pkgconfig/libkrun.pc
            /usr/local/include/libkrun.h
          key: libkrun-ubuntu-${{ env.LIBKRUN_VERSION }}-v4

      - name: Build libkrun
        if: steps.cache-libkrun.outputs.cache-hit != 'true'
        run: |
          # Install additional build dependencies for libkrun
          sudo apt-get install -y patchelf
          
          git clone --depth 1 --branch v${{ env.LIBKRUN_VERSION }} \
            https://github.com/containers/libkrun.git /tmp/libkrun
          cd /tmp/libkrun
          
          # Create fake init binary (not needed for library build)
          mkdir -p init && touch init/init
          
          # Build libkrun with PREFIX=/usr/local
          # libkrunfw must be findable by the linker (installed to /lib/x86_64-linux-gnu)
          RUSTFLAGS="-A warnings" make PREFIX=/usr/local
          sudo make PREFIX=/usr/local install
          
          # Update library cache
          sudo ldconfig

      - name: Setup library paths for libkrun
        run: |
          # Symlink lib64 libs to lib for tools that expect lib/
          sudo mkdir -p /usr/local/lib/pkgconfig
          for f in /usr/local/lib64/libkrun*; do
            [ -f "$f" ] && sudo ln -sf "$f" /usr/local/lib/$(basename "$f")
          done
          # Also symlink pkgconfig
          [ -f /usr/local/lib64/pkgconfig/libkrun.pc ] && \
            sudo ln -sf /usr/local/lib64/pkgconfig/libkrun.pc /usr/local/lib/pkgconfig/
          # Add lib64 to ldconfig
          echo "/usr/local/lib64" | sudo tee /etc/ld.so.conf.d/local-lib64.conf
          sudo ldconfig

      - name: Verify library installation
        run: |
          echo "=== Checking /usr/local/lib64 ==="
          ls -la /usr/local/lib64/ || true
          ls -la /usr/local/lib64/pkgconfig/ || true
          echo "=== Checking /usr/local/lib ==="
          ls -la /usr/local/lib/ || true
          ls -la /usr/local/lib/pkgconfig/ || true
          echo "=== Checking /usr/local/include ==="
          ls -la /usr/local/include/ || true
          ls -la /usr/local/include/libkrun* || true
          echo "=== pkg-config checks ==="
          pkg-config --modversion libcrun
          pkg-config --modversion libkrun
          pkg-config --libs libkrun
          pkg-config --cflags libkrun

      - name: Check formatting
        run: cargo fmt --check

      - name: Debug environment before build
        run: |
          echo "=== Environment Variables ==="
          echo "LIBCLANG_PATH=${LIBCLANG_PATH}"
          echo "LLVM_CONFIG_PATH=${LLVM_CONFIG_PATH}"
          echo "LD_LIBRARY_PATH=${LD_LIBRARY_PATH}"
          echo ""
          echo "=== Checking LIBCLANG_PATH ==="
          if [ -d "${LIBCLANG_PATH}" ]; then
            echo "LIBCLANG_PATH points to directory: ${LIBCLANG_PATH}"
            echo "Contents:"
            ls -la "${LIBCLANG_PATH}"/libclang* 2>/dev/null || echo "No libclang files found"
          elif [ -f "${LIBCLANG_PATH}" ]; then
            echo "WARNING: LIBCLANG_PATH points to a file (should be directory): ${LIBCLANG_PATH}"
            ls -la "${LIBCLANG_PATH}"
          else
            echo "ERROR: LIBCLANG_PATH does not exist: ${LIBCLANG_PATH}"
            exit 1
          fi
          echo ""
          echo "=== Test loading libclang from directory ==="
          LIBCLANG_FILE="${LIBCLANG_PATH}/libclang.so"
          if [ -f "${LIBCLANG_FILE}" ] || [ -L "${LIBCLANG_FILE}" ]; then
            python3 -c "
          import ctypes
          lib = ctypes.CDLL('${LIBCLANG_FILE}')
          print('SUCCESS: Loaded ${LIBCLANG_FILE}')
          "
          else
            echo "ERROR: libclang.so not found in ${LIBCLANG_PATH}"
            exit 1
          fi

      - name: Clippy
        run: cargo clippy --workspace -- -D warnings -A clippy::too_many_arguments

      - name: Build
        run: cargo build --workspace

      - name: Run tests
        run: cargo test --workspace

      - name: Build release
        run: cargo build --release --workspace
