name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  LIBCRUN_VERSION: "1.19.1"

jobs:
  # Linux: Full build and test with libcrun
  linux:
    name: Linux (with libcrun)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkgconf \
            autoconf \
            automake \
            libtool \
            make \
            gcc \
            git \
            python3 \
            libseccomp-dev \
            libcap-dev \
            libyajl-dev \
            llvm-dev \
            libclang-dev \
            clang
            

      - name: Set up Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy

      - name: Cache libcrun build
        id: cache-libcrun
        uses: actions/cache@v4
        with:
          path: /usr/local
          key: libcrun-ubuntu-${{ env.LIBCRUN_VERSION }}-v5

      - name: Build libcrun
        if: steps.cache-libcrun.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch ${{ env.LIBCRUN_VERSION }} \
            https://github.com/containers/crun.git /tmp/crun
          cd /tmp/crun
          
          ./autogen.sh
          ./configure \
            --prefix=/usr/local \
            --disable-systemd
          
          make -j$(nproc)
          sudo make install
          
          # Manually create pkgconfig file (crun doesn't provide one)
          sudo mkdir -p /usr/local/lib/pkgconfig
          sudo tee /usr/local/lib/pkgconfig/libcrun.pc << 'PKGEOF'
          prefix=/usr/local
          exec_prefix=${prefix}
          libdir=${exec_prefix}/lib
          includedir=${prefix}/include
          
          Name: libcrun
          Description: OCI runtime library
          Version: ${{ env.LIBCRUN_VERSION }}
          Libs: -L${libdir} -lcrun -lyajl -lseccomp -lcap
          Cflags: -I${includedir}
          PKGEOF
          
          # Install headers
          sudo mkdir -p /usr/local/include/libcrun
          sudo mkdir -p /usr/local/include/ocispec
          sudo cp src/libcrun/*.h /usr/local/include/libcrun/
          sudo cp config.h /usr/local/include/
          # Copy ocispec headers (generated during build)
          find libocispec -name "*.h" -exec sudo cp {} /usr/local/include/ocispec/ \;

      - name: Verify libcrun installation
        run: |
          ls -la /usr/local/lib/
          ls -la /usr/local/lib/pkgconfig/
          pkg-config --modversion libcrun
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig

      - name: Check formatting
        run: cargo fmt --check

      - name: Clippy
        run: cargo clippy --workspace --no-default-features -- -D warnings -A clippy::too_many_arguments
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
          LD_LIBRARY_PATH: /usr/local/lib

      - name: Build
        run: cargo build --workspace --no-default-features
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
          LD_LIBRARY_PATH: /usr/local/lib

      - name: Run tests
        run: cargo test --workspace --no-default-features
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
          LD_LIBRARY_PATH: /usr/local/lib

      - name: Build release
        run: cargo build --release --workspace --no-default-features
        env:
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
          LD_LIBRARY_PATH: /usr/local/lib
